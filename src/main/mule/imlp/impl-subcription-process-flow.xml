<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="impl-subcription-process-flowSub_Flow"
		doc:id="76514eb0-6a68-43f2-8b94-85dd144f2539">
		<set-variable value="#[payload]"
			doc:name="originalPayload"
			doc:id="ce694bbf-82f0-4feb-94fc-ddcc8ddd9d95"
			variableName="originalPayload" />
		<try doc:name="Try" doc:id="f71b769b-db02-4ae8-a2d8-426da049ed92">
			<flow-ref doc:name="Flow Ref to get-redis-cache-brand-flow"
				doc:id="bca513ea-5ccf-46b4-ae26-fef75c66dfe5"
				name="get-redis-cache-brand-flow" target="redisResponse" />
			<error-handler>
				<on-error-continue enableNotifications="true"
					logException="true" doc:name="On Error Continue"
					doc:id="f601eb2e-fe52-4c79-aef2-f62edc56698a">
					<logger level="INFO" doc:name="Logger"
						doc:id="9c95f29a-1751-44be-8d51-6b1d7b4b9998" />
				</on-error-continue>
			</error-handler>
		</try>
		<choice doc:name="Choice"
			doc:id="5ae4d3cb-1041-498f-a556-d42cd77dca03">
			<when expression="#[!isEmpty(vars.redisResponse.results)]">
				<logger level="INFO" doc:name="Do Nothing"
					doc:id="1a839f40-98cd-445d-80a6-21795d3729d5" />
			</when>
			<otherwise>
				<flow-ref doc:name="Flow Ref to get-prefix-bridge-api-flow"
					doc:id="a1139099-63cd-4125-97ba-c8b15c4a6cef"
					name="get-prefix-bridge-api-flow" target="bridgeResponse" />
				<flow-ref
					doc:name="Flow Ref to post-redis-cache-brand-flow"
					doc:id="accd2fa4-5299-4ee3-af1e-f77a75b69c1e"
					name="post-redis-cache-brand-flow" />
			</otherwise>
		</choice>
		<ee:transform doc:name="Set Brand ID and Brand NAme"
			doc:id="a6e5a8b8-6614-4a6e-a154-8a99397e13ea">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="brand"><![CDATA[%dw 2.0
output application/json
---
{
  "prefix": "93640",
  "brand-id":1 ,
  "brand-name": "TM"
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<choice doc:name="Choice"
			doc:id="c5043fb0-326f-47c0-8a1a-9f1ac4044234">
			<when
				expression='#[[1, 2, 3] contains (vars.brand."brand-id" default 0)]'>
				<flow-ref doc:name="Flow ref to get-redis-cache-state-flow"
					doc:id="bc5b0110-f84c-460a-b145-6e261d37780b"
					name="get-redis-cache-state-flow" target="stateResponse" />
				<choice doc:name="Choice"
					doc:id="92cae739-4cc2-4684-b1b9-4bfd2f23af4b">
					<when
						expression='#[vars.originalPayload.keyword == "OPT-IN"]'>
						<choice doc:name="Choice" doc:id="4b2095ca-858c-4505-a7fd-f624563a788e" >
							<when expression="#[vars.stateResponse.state == 1]">
								<ee:transform doc:name="Opt it dual provi" doc:id="5578edea-7195-42ea-b033-f6f0f854386c" >
									<ee:message >
										<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
}]]></ee:set-payload>
									</ee:message>
								</ee:transform>
							</when>
							<otherwise>
								<choice doc:name="Choice" doc:id="692ecaf5-c10d-426a-a4b3-a0b74c4a89b3" >
									<when expression='#[[1, 2] contains (vars.brand."brand-id")]'>
										<flow-ref doc:name="flow ref to sys-nf-api-flowFlow" doc:id="e53f264e-dbad-4e45-ad0d-2da43861cbdd" name="sys-nf-api-flowFlow" target="nfResponse"/>
									</when>
									<otherwise >
										<flow-ref doc:name="Flow ref to get-bss-msisdn-eligibility-flow" doc:id="1d0ce3c7-03cb-49a3-a586-ade7661a04b8" name="get-bss-msisdn-eligibility-flow"/>
									</otherwise>
								</choice>
								<flow-ref doc:name="Flow Ref to post-provision-to-facebook-flow" doc:id="3880677b-5ae3-4b60-a48e-3c37eb5dec60" name="post-redis-cache-brand-flow" />
								<flow-ref doc:name="Flow ref to put-redis-cache-state-flow" doc:id="29692233-4825-4be7-acf8-0b32d3a59939" name="put-redis-cache-state-flow" />
							</otherwise>
						</choice>
					</when>
					<when expression='#[vars.originalPayload.keyword == "OPT-OUT"]' >
						<choice doc:name="Choice" doc:id="65395059-2e83-4c02-9b5c-5aec103aa9be" >
							<when expression="#[vars.stateResponse.state == 0]">
								<logger level="INFO" doc:name="duAL OFF sPIEL" doc:id="6902d37b-c7d9-4897-ad4b-81a11917f0cc" />
							</when>
							<when expression="#[vars.stateResponse.state == 1]" >
								<flow-ref doc:name="Flow ref to post-provision-to-facebook-flow" doc:id="35900247-b2f6-4154-8103-bcea509a4ac1" name="post-provision-to-facebook-flow"/>
							</when>
							<otherwise >
								<logger level="INFO" doc:name="FB NOT REGISTERED SPIEL" doc:id="38e315bb-a719-4754-b057-2690286dacd9" />
							</otherwise>
						</choice>
					</when>
					<otherwise >
						<choice doc:name="Choice" doc:id="46977877-5241-42b2-9dbe-f67ebd1500c7" >
							<when expression="#[vars.stateResponse.state == 1]">
								<logger level="INFO" doc:name="BONUS DUAL ON" doc:id="1bfd2b67-4547-4652-bcd4-6710a7db4ec2" message="Dual Provion"/>
							</when>
							<when expression="#[vars.stateResponse.state == 0]">
								<logger level="INFO" doc:name="BONUS NOT ELIGABLE" doc:id="fd252694-fe73-444a-af9a-7ea004ca6f70" />
							</when>
							<otherwise>
								<flow-ref doc:name="Flow ref to get-msisdn-whitelist-flow" doc:id="d67c1822-b0ed-4cf3-ad8d-242d30028a06" name="get-msisdn-whitelist-flow"/>
							</otherwise>
						</choice>
					</otherwise>
				</choice>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Raise Error" doc:id="e719fcc9-b14b-41b0-a715-48fe007b860f" />
			</otherwise>
		</choice>
	</sub-flow>
</mule>
