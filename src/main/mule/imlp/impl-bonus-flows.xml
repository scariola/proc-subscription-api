<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="impl-get-whitelist-subflow" doc:id="0733ca1e-3f88-44e1-b269-75060c40be60" >
		<logger level="INFO" doc:name="START - Bonus Handling" doc:id="7342fb82-26dd-43d8-a0ee-b63f55b976aa" message="END- Bonus Handling"/>
		<flow-ref doc:name="get-msisdn-whitelist-flow" doc:id="d6afa47b-bd5d-4c20-96fe-f01cc02833a9" name="get-msisdn-whitelist-flow" />
		<choice doc:name="Choice" doc:id="99dc84f5-cd97-4778-ac3b-375d5a7d6a8f">
			<when expression="#[(isEmpty(payload.result) and payload.results.eligible == true)]">
				<ee:transform doc:name="MongoDB Respose TO API Response" doc:id="d3e06656-8cee-454a-a61b-932c25e3e328">
			<ee:message>
			</ee:message>
					<ee:variables>
						<ee:set-variable variableName="expiryDetails"><![CDATA[%dw 2.0
output application/json
---
{
  "service-id": vars.originalPayload.'as-service-id',
  "expiry-date": (now() + |P7D|) as String { format: "yyyy-MM-dd HH:mm:ss" }
}
]]></ee:set-variable>
					</ee:variables>
		</ee:transform>
			</when>
			<otherwise>
				<ee:transform doc:name="var - spielType" doc:id="31d744bb-e3d1-4d77-ae01-1e676216130d">
					<ee:message>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="speilType" ><![CDATA[%dw 2.0
output application/json
---
'not-eligable']]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="common-set-success-audit-log-subflow" doc:id="12308ad0-e251-4d3c-86a5-36e075deb864" name="common-set-success-audit-log-subflow"/>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="END- Bonus Handling" doc:id="df6901fa-b2c0-4954-a8f9-e942d16a5ee4" message="END- Bonus Handling"/>
	</sub-flow>
	<sub-flow name="impl-delete-whitelist-subflow" doc:id="ef115c77-c1c4-47f2-8010-8d7b8279b24d" >
		<until-successful maxRetries="5" doc:name="Until Successful" doc:id="823c5073-3929-4609-bcac-26aae24457f1">
			<try doc:name="Try" doc:id="610e64df-3d72-47d3-a802-46289fad33e5">
			<flow-ref doc:name="delete-msisdn-whitelist-flow" doc:id="035637e0-7bb5-41aa-96ce-c1b7b9b76e83" name="delete-msisdn-whitelist-flow" />
				<error-handler>
					<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="a7031c03-429d-4934-a1d8-49cda0a1b159" type="ANY">
						<logger level="INFO" doc:name="Logger" doc:id="6198af09-2396-490f-8a96-ccc2fdcc5734" />
					</on-error-propagate>
				</error-handler>
		</try>
			<choice doc:name="Choice" doc:id="0acb782c-0845-49b0-8701-75b41723d872">
				<when expression="#[attributes.statusCode != 200]">
					<logger level="INFO" doc:name="Logger" doc:id="da97cf61-afcd-43ac-b553-77a8a16b7089" />
				</when>
			</choice>
		</until-successful>
	</sub-flow>
</mule>
