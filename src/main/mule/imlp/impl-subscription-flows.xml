<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<sub-flow name="impl-post-subscription-subflow"
		doc:id="bd2e8438-d23d-4920-a8cf-fc152b7d4f25">
		<flow-ref doc:name="impl-post-audit-subflow"
			doc:id="5841db2c-87c4-436c-98c2-d148b3643619"
			name="impl-post-audit-subflow" />
		<flow-ref doc:name="impl-sms-validation-flow"
			doc:id="d4826b9f-7be8-41b0-8915-02076282c04c"
			name="impl-sms-validation-flow" />
		<flow-ref doc:name="impl-redis-process-subflow"
			doc:id="df1eddac-db79-438b-bf53-3012de73f9f2"
			name="impl-redis-process-subflow" />
		<choice doc:name="ROUTE request Based ON spielType Outcome"
			doc:id="bcbd3d62-7c2b-4d65-a101-f2fa55a86bac">
			<when
				expression="#[vars.spielType != null and vars.spielType != 'first-time' and vars.spielType != 'eligible' and vars.spielType != 'normal-off']">
				<flow-ref doc:name="impl-put-audit-subflow"
					doc:id="2623c06b-9fe0-4168-a3fe-1a0d4fe04af0"
					name="impl-put-audit-subflow" />
				<flow-ref doc:name="impl-post-sms-subflow"
					doc:id="f0306105-5b5b-44ce-b245-16f64fddc2b7"
					name="impl-post-sms-subflow" />
			</when>
			<otherwise>
				<choice doc:name="IS Keyword OPT-IN? ROUTE TO Eligibility"
					doc:id="2398692e-14e2-48e1-9b0c-4648d5b0c0eb">
					<when
						expression="#[vars.formattedSubscriberData.keyword == 'OPT-IN']">
						<flow-ref doc:name="impl-elgibility-check-subflow"
							doc:id="210ab367-276a-4056-a5fc-21516a672df9"
							name="impl-elgibility-check-subflow" />
					</when>
				</choice>
				<flow-ref doc:name="impl-provision-subflow"
					doc:id="680793fa-786c-47ed-839e-92b10afa765d"
					name="impl-post-provision-subflow" />
				<flow-ref doc:name="impl-post-state-subflow"
					doc:id="5e096604-0e76-4a76-bca5-870f7d8c1b92"
					name="impl-post-state-subflow" />
				<flow-ref doc:name="impl-put-audit-subflow"
					doc:id="f99817a2-bd6b-4386-a0e0-27864ad9d94a"
					name="impl-put-audit-subflow" />
				<flow-ref doc:name="impl-post-sms-subflow"
					doc:id="8050e4dc-5508-4fa4-8c19-191ce1f981d2"
					name="impl-post-sms-subflow" />
			</otherwise>
		</choice>
	</sub-flow>
	
	<sub-flow name="impl-post-audit-subflow"
		doc:id="81ed1a62-3c83-4c4e-9846-f937046c7ffb">
		<logger level="INFO" doc:name="START - Audit Logging Process"
			doc:id="07963c6a-5d72-4776-917c-cbda22b3dd60"
			message="START - Audit Logging Process - STEP 1: AUDIT LOGGING" />
		<ee:transform doc:name="Payload to Audit API Request"
			doc:id="f672b6bb-985b-4ac4-b353-4b8db56c5c83">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "csp_txid": payload.'transaction-id',
  "sms_message_string":payload.'sms-message',
  "sub_mobtel": payload.msisdn,
  "sms_source_address": payload.'sms-source-address',
  "sub_device_details":payload.'sub-device',
  "hplmn": payload.hlprm,
  "as_service_id": payload.'as-service-id'
}

]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="sys-audit-api-post-audit-flow"
			doc:id="47620c83-ad7e-497d-8d42-ce73446ecbcf"
			name="sys-audit-api-post-audit-flow" />
		<ee:transform doc:name="var-auditId"
			doc:id="748a0edb-39c4-45d8-94d9-57a8df7de6da">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="auditId"><![CDATA[%dw 2.0
output application/json
---
{
	"audit-id": payload.id
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="END  - Audit Logging Process"
			doc:id="125a6417-0c97-4601-904d-65d2e5ef1d3a"
			message="END - Audit Logging Process - STEP 1: AUDIT LOGGING" />
	</sub-flow>
</mule>
